<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VeriFact AI — Profile</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Inter", sans-serif;
  background: linear-gradient(180deg,#f8fdff,#e8f4ff);
}

.navbar {
  border-bottom:1px solid rgba(0,0,0,0.05);
  background:white;
}

.card-soft {
  border-radius:14px;
  border:1px solid rgba(0,0,0,0.05);
  box-shadow:0 6px 18px rgba(15,23,42,0.06);
}

.badge-chip {
  border-radius:999px;
  padding:4px 10px;
  background:#e5f0ff;
  color:#1f2937;
  font-size:0.75rem;
  margin:2px;
}

.saved-img {
  width:80px;
  height:60px;
  object-fit:cover;
  border-radius:8px;
  background:#dce8f7;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg py-3">
  <div class="container-fluid px-4">
    <a class="navbar-brand fw-bold text-primary" href="{{ url_for('home_page') }}">VeriFact AI</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('home_page') }}">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('dashboard_page') }}">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('features_page') }}">Features</a>
        </li>
      </ul>

      <div class="d-flex align-items-center gap-3">
        <span class="fw-semibold">Hi, {{ username }}</span>
        <a href="{{ url_for('route_logout_get') }}" class="btn btn-danger btn-sm">Logout</a>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row g-4">

    <!-- Left: profile + preferences -->
    <div class="col-lg-4">
      <div class="card card-soft mb-4 p-3">
        <div class="d-flex align-items-center gap-3">
          <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:56px;height:56px;font-size:1.5rem;">
            {{ username[0]|upper }}
          </div>
          <div>
            <h5 class="mb-0">{{ username }}</h5>
            <p class="text-muted small mb-1">VeriFact AI User</p>
            <span class="badge bg-success-subtle text-success border border-success-subtle" style="font-size:0.7rem;">
              Preferences synced with Dashboard
            </span>
          </div>
        </div>
      </div>

      <div class="card card-soft p-3">
        <h6 class="fw-bold mb-2">Your Preferences</h6>
        <p class="text-muted small mb-2">Topics you follow:</p>
        <div id="prefTopicsBox" class="mb-2"></div>

        <p class="text-muted small mb-2">Sources you prefer:</p>
        <div id="prefSourcesBox" class="mb-2"></div>

        <p class="text-muted small mb-1">View type:</p>
        <div id="prefTypeText" class="fw-semibold small"></div>

        <button id="editPrefsBtn" class="btn btn-outline-primary btn-sm mt-3">Edit in Dashboard</button>
      </div>
    </div>

    <!-- Right: saved + reports -->
    <div class="col-lg-8">
      <div class="card card-soft mb-4 p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">Saved Articles</h6>
          <span id="savedCount" class="text-muted small"></span>
        </div>
        <div id="savedList"></div>
        <p id="savedEmpty" class="text-muted small mb-0 d-none">You haven't saved any articles yet. Use the <strong>Save</strong> button on the dashboard.</p>
      </div>

      <div class="card card-soft p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">Your Reports</h6>
          <span id="reportCount" class="text-muted small"></span>
        </div>
        <div id="reportsList" style="max-height:260px;overflow:auto;"></div>
        <p id="reportsEmpty" class="text-muted small mb-0 d-none">No reports yet. You can mark suspicious news as fake from the dashboard.</p>
      </div>
    </div>

  </div>
</div>

<script>
function api(path, opts={}) {
  return fetch(path, {
    credentials: "include",
    headers: {"Content-Type":"application/json"},
    ...opts
  }).then(async res => ({ok: res.ok, json: await res.json().catch(()=>({}))}));
}

// ---- Preferences summary ----
async function loadPreferences(){
  const res = await api("/user/preferences");
  if(!res.ok) return;
  const p = res.json;

  const topicsBox = document.getElementById("prefTopicsBox");
  const srcBox = document.getElementById("prefSourcesBox");
  const typeText = document.getElementById("prefTypeText");

  topicsBox.innerHTML = "";
  (p.topics || []).forEach(t=>{
    topicsBox.insertAdjacentHTML("beforeend", `<span class="badge-chip">${t}</span>`);
  });
  if(!(p.topics||[]).length) topicsBox.innerHTML = '<span class="text-muted small">No topics selected.</span>';

  srcBox.innerHTML = "";
  (p.sources || []).forEach(s=>{
    srcBox.insertAdjacentHTML("beforeend", `<span class="badge-chip">${s}</span>`);
  });
  if(!(p.sources||[]).length) srcBox.innerHTML = '<span class="text-muted small">No specific sources selected.</span>';

  typeText.innerText = p.type === "verified" ? "Verified news only" : "All news";
}

document.getElementById("editPrefsBtn").onclick = ()=>{
  window.location.href = "{{ url_for('dashboard_page') }}#preferences";
};

// ---- Saved articles ----
async function loadSaved(){
  const res = await api("/user/saved");
  const listEl = document.getElementById("savedList");
  const emptyEl = document.getElementById("savedEmpty");
  const countEl = document.getElementById("savedCount");

  listEl.innerHTML = "";
  if(!res.ok || !res.json.length){
    emptyEl.classList.remove("d-none");
    countEl.innerText = "0 saved";
    return;
  }
  emptyEl.classList.add("d-none");
  countEl.innerText = `${res.json.length} saved`;

  res.json.forEach(a=>{
    listEl.insertAdjacentHTML("beforeend", `
      <div class="d-flex align-items-center mb-2">
        <img src="${a.image_url || '/static/images/default-news.jpg'}" class="saved-img me-3" alt="">
        <div class="flex-grow-1">
          <div class="small fw-semibold">${a.title || ""}</div>
          <div class="text-muted small">${a.source || ""} • ${a.published_at || ""}</div>
          <a href="${a.url}" target="_blank" class="small text-primary">Open article ↗</a>
        </div>
      </div>
    `);
  });
}

// ---- Reports ----
async function loadReports(){
  const res = await api("/user/reports");
  const listEl = document.getElementById("reportsList");
  const emptyEl = document.getElementById("reportsEmpty");
  const countEl = document.getElementById("reportCount");

  listEl.innerHTML = "";
  if(!res.ok || !res.json.length){
    emptyEl.classList.remove("d-none");
    countEl.innerText = "0 reports";
    return;
  }
  emptyEl.classList.add("d-none");
  countEl.innerText = `${res.json.length} reports`;

  res.json.forEach(r=>{
    listEl.insertAdjacentHTML("beforeend", `
      <div class="border-bottom py-1">
        <div class="small">
          <strong>${r.label}</strong> •
          <a href="${r.url}" target="_blank" class="text-primary">View article</a>
        </div>
        <div class="text-muted small">${r.reason || "No reason given"}</div>
        <div class="text-muted small">${r.timestamp || ""}</div>
      </div>
    `);
  });
}

(async ()=>{
  await loadPreferences();
  await loadSaved();
  await loadReports();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
